#INCLUDE "../Kep.hjk"

#DEFINE TEST_TIMERS 32

KeuTestTimers : KeTimer[TEST_TIMERS]
KeuTestDpcs : KeDpc[TEST_TIMERS]

FN (KeDpcF) KepTestDpcF (
    IN dpc : ^KeDpc,
    IN context1 : UWORD,
    IN context2 : UWORD,
)

    RtlPrint ( "Expired " )
END

FN KepTest ()

    i := 0

    WHILE i < TEST_TIMERS DO
        KeInitializeDpc (
            &KepTestDpcs[i], // dpc
            &KepTestDpcF, // func
        )

        KeInitializeTimer (
            &KepTestTimers[i], // timer
            &KepTestDpcs[i], // dpc
            "Timer", // name
        )

        i += 1
    END 
END

FN KepIdleLoopTest ()

    interval : RtlUquad

    interval.High = 0
    interval.Low = 1000

    i := 0
    enq := TRUE

    WHILE TRUE DO
        IF i >= TEST_TIMERS THEN
            i = 0
            enq = NOT enq
        END

        IF enq THEN
            KeEnqueueTimer (
                &KepTestTimers[i], // timer
                &interval, // interval
                0, // context1
                0, // context2
            )

        ELSE
            KeDequeueTimer ( &KepTestTimers[i] )
        END

        i += 1
    END
END